<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Pathirage Electronics - Repair Manager</title>
    <meta name="theme-color" content="#007bff">
    <style>
        /* (kept original styling, slightly compacted) */
        body { font-family: Arial, sans-serif; padding: 15px; background: #f8f9fa; max-width:100%; margin:0 auto; }
        .container { background:white; padding:20px; border-radius:10px; box-shadow:0 2px 10px rgba(0,0,0,0.1); }
        h1,h2{ color:#007bff; margin:0 0 8px 0; }
        label{ display:block; margin-top:15px; font-weight:bold; }
        input,select,textarea{ width:100%; padding:10px; margin-top:5px; border:1px solid #ddd; border-radius:5px; font-size:16px; box-sizing:border-box }
        button{ background:#007bff; color:white; border:none; padding:12px 20px; margin-top:20px; border-radius:5px; cursor:pointer; font-size:16px }
        button:hover{ background:#0056b3 }
        .job{ background:#f1f1f1; padding:15px; margin-top:15px; border-radius:8px; border-left:4px solid #007bff; position:relative }
        .job-status{ padding:3px 8px; border-radius:4px; font-weight:bold; color:white }
        .payment-status{ display:inline-block; padding:3px 8px; border-radius:4px; font-weight:bold; color:white }
        .delivered{ background:green }
        .ready{ background:orange }
        .progress{ background:#007bff }
        .pending{ background:red }
        .paid{ background:green }
        .partial{ background:orange }
        .unpaid{ background:red }
        .actions{ display:flex; gap:10px; margin-top:20px; flex-wrap:wrap }
        .search-box{ width:100%; padding:12px; font-size:16px; border:2px solid #007bff; border-radius:5px; margin:15px 0 }
        #exportBtn{ background:#28a745 }
        #searchBtn{ background:#ffc107; color:#212529 }
        #clearSearchBtn{ background:#dc3545; color:white }
        .complete-btn, .edit-btn, .edit-payment-btn, .sms-btn, .receipt-btn, .deliver-btn { padding:6px 10px; font-size:12px; margin-top:5px; border-radius:4px; cursor:pointer; margin-right:5px; margin-bottom:5px; }
        .complete-btn, .deliver-btn { background:#28a745; color:white }
        .edit-btn{ background:#17a2b8; color:white }
        .edit-payment-btn{ background:#ffc107; color:#212529 }
        .sms-btn{ background:#007bff; color:white }
        .receipt-btn{ background:#6f42c1; color:white }
        .modal{ display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:100; align-items:center; justify-content:center }
        .modal-content{ background:white; padding:20px; border-radius:10px; width:90%; max-width:400px; text-align:left }
        .modal-title{ margin-top:0; color:#007bff }
        .modal-actions{ margin-top:20px; display:flex; gap:10px }
        .tabs{ display:flex; margin-bottom:20px; border-bottom:2px solid #007bff }
        .tab{ padding:10px 20px; cursor:pointer; background:#f1f1f1; border:none; font-weight:bold }
        .tab.active{ background:#007bff; color:white }
        .footer{ margin-top:30px; padding:15px; background:#007bff; color:white; text-align:center; border-radius:8px; font-weight:bold }
        .job-number{ background:#6c757d; color:white; padding:3px 8px; border-radius:4px; font-size:14px; font-weight:bold }
        .receipt-content{ display:none }
        @media print { body * { visibility:hidden } .receipt-content, .receipt-content * { visibility:visible } .receipt-content { position:absolute; left:0; top:0; width:58mm; margin:0; padding:3mm 2mm; font-family:'Courier New', monospace; font-size:11px; line-height:1.3; box-sizing:border-box } .receipt-content button, .receipt-content .actions { display:none !important } }
        #syncStatus{ position:fixed; bottom:10px; right:10px; padding:5px 10px; border-radius:5px; font-size:12px; font-weight:bold; color:white; z-index:1000 }
        .sync-online{ background:green }
        .sync-offline{ background:orange }
        .sync-syncing{ background:#007bff }
    </style>
</head>
<body>
    <div class="container">
        <h1>üì± Pathirage Electronics</h1>
        <p style="color:#666;font-size:14px">Repair Shop Manager (LKR)</p>

        <div class="form">
            <label>Customer Name *</label>
            <input type="text" id="customerName" placeholder="e.g. John Doe" required>

            <label>Phone *</label>
            <input type="tel" id="customerPhone" placeholder="e.g. 0712345678" required>

            <label>Address</label>
            <textarea id="customerAddress" rows="2" placeholder="House #, Street, City"></textarea>

            <label>Brand</label>
            <input type="text" id="deviceBrand" placeholder="e.g. Samsung, Apple, Dell">

            <label>Model *</label>
            <input type="text" id="deviceModel" placeholder="e.g. Galaxy S23, MacBook Pro" required>

            <label>Issue Description</label>
            <textarea id="issueDesc" rows="3" placeholder="Describe the problem..."></textarea>

            <label>Repair Date (Received)</label>
            <input type="date" id="repairDate">

            <label>Expected Delivery Date</label>
            <input type="date" id="deliveryDate">

            <label>Status</label>
            <select id="status">
                <option value="Pending">Pending</option>
                <option value="In Progress">In Progress</option>
                <option value="Ready for Pickup">Ready for Pickup</option>
            </select>

            <button id="saveBtn">üíæ Save Repair Job</button>
        </div>

        <div class="actions">
            <input type="text" id="searchInput" class="search-box" placeholder="üîç Search by Name, Phone, or Job Number (e.g. PE-2025-0001)">
            <button id="searchBtn">Search</button>
            <button id="clearSearchBtn">Clear</button>
            <button id="exportBtn">üì§ Export All Jobs</button>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" data-tab="active">üîß Active Jobs</button>
            <button class="tab" data-tab="all">üìã All Jobs</button>
        </div>

        <div id="jobList">
            <!-- Jobs will appear here -->
        </div>

        <div class="footer">
            ‚òéÔ∏è Hotline: 070 607 7 607<br>
            üõ†Ô∏è Pathirage Electronics - We Care For Your Devices
        </div>
    </div>

    <!-- Modals (same as original) -->
    <div id="completeModal" class="modal"><div class="modal-content">
        <h3 class="modal-title">‚úÖ Complete Repair</h3>
        <label>Repair Price (LKR)</label><input type="number" id="modalPrice" min="0" step="0.01" placeholder="e.g. 1500.00">
        <label>Amount Paid (LKR)</label><input type="number" id="modalPaid" min="0" step="0.01" placeholder="e.g. 1000.00">
        <div class="modal-actions"><button id="modalSaveBtn">üíæ Save & Mark Ready for Pickup</button><button id="modalCancelBtn">‚ùå Cancel</button></div>
    </div></div>

    <div id="paymentModal" class="modal"><div class="modal-content">
        <h3 class="modal-title">‚úèÔ∏è Edit Price & Payment</h3>
        <label>Repair Price (LKR)</label><input type="number" id="editPrice" min="0" step="0.01" placeholder="e.g. 1500.00">
        <label>Amount Paid (LKR)</label><input type="number" id="editPaid" min="0" step="0.01" placeholder="e.g. 1000.00">
        <div class="modal-actions"><button id="editSaveBtn">üíæ Save Changes</button><button id="editCancelBtn">‚ùå Cancel</button></div>
    </div></div>

    <div id="editJobModal" class="modal"><div class="modal-content">
        <h3 class="modal-title">‚úèÔ∏è Edit Job Details</h3>
        <input type="hidden" id="editJobId">
        <label>Job Number</label><input type="text" id="editJobNumber" readonly>
        <label>Customer Name</label><input type="text" id="editCustomerName" placeholder="e.g. John Doe">
        <label>Phone</label><input type="tel" id="editCustomerPhone" placeholder="e.g. 0712345678">
        <label>Address</label><textarea id="editCustomerAddress" rows="2" placeholder="House #, Street, City"></textarea>
        <label>Brand</label><input type="text" id="editDeviceBrand" placeholder="e.g. Samsung, Apple, Dell">
        <label>Model</label><input type="text" id="editDeviceModel" placeholder="e.g. Galaxy S23, MacBook Pro">
        <label>Issue Description</label><textarea id="editIssueDesc" rows="3" placeholder="Describe the problem..."></textarea>
        <label>Repair Date</label><input type="date" id="editRepairDate">
        <label>Expected Delivery Date</label><input type="date" id="editDeliveryDate">
        <label>Status</label>
        <select id="editStatus">
            <option value="Pending">Pending</option>
            <option value="In Progress">In Progress</option>
            <option value="Ready for Pickup">Ready for Pickup</option>
            <option value="Delivered">Delivered</option>
        </select>
        <div class="modal-actions"><button id="saveEditBtn">üíæ Save Changes</button><button id="cancelEditBtn">‚ùå Cancel</button></div>
    </div></div>

    <!-- Receipt container -->
    <div class="receipt-content" id="receiptContent"></div>

    <!-- Sync indicator -->
    <div id="syncStatus" class="sync-offline">OFFLINE</div>

    <!-- Supabase + App logic -->
    <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/supabase-esm.js';

    // ----------------- CONFIG -----------------
    const SUPABASE_URL = 'https://tzcttdubkddjyaohqhku.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR6Y3R0ZHVia2Rkanlhb2hxaGt1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA0NjEwMjEsImV4cCI6MjA3NjAzNzAyMX0.MjP-Dze6XpWWqQs7oWBrt_zrmK1Bamyot-K-Z4ST-pk';
    // ------------------------------------------

    // Supabase client
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, { realtime: { params: { eventsPerSecond: 5 } } });

    // Local storage keys
    const STORAGE_KEY = 'repairJobs_v2';
    const LS_REPAIRS = 'pos_repairs_v2';
    const LS_SALES = 'pos_sales_v2';
    const LS_INVENTORY = 'pos_inventory_v2';
    const LS_QUEUE = 'pos_sync_queue_v2';

    // DOM refs
    const saveBtn = document.getElementById('saveBtn');
    const jobListEl = document.getElementById('jobList');
    const exportBtn = document.getElementById('exportBtn');
    const searchInput = document.getElementById('searchInput');
    const searchBtn = document.getElementById('searchBtn');
    const clearSearchBtn = document.getElementById('clearSearchBtn');
    const tabs = document.querySelectorAll('.tab');
    const receiptContent = document.getElementById('receiptContent');
    const syncStatus = document.getElementById('syncStatus');
    const lastSyncKey = 'pos_last_sync';

    // Modals & inputs (existing)
    const completeModal = document.getElementById('completeModal');
    const paymentModal = document.getElementById('paymentModal');
    const editJobModal = document.getElementById('editJobModal');
    const modalPrice = document.getElementById('modalPrice');
    const modalPaid = document.getElementById('modalPaid');
    const editPrice = document.getElementById('editPrice');
    const editPaid = document.getElementById('editPaid');
    const editJobId = document.getElementById('editJobId');
    const editJobNumber = document.getElementById('editJobNumber');
    const editCustomerName = document.getElementById('editCustomerName');
    const editCustomerPhone = document.getElementById('editCustomerPhone');
    const editCustomerAddress = document.getElementById('editCustomerAddress');
    const editDeviceBrand = document.getElementById('editDeviceBrand');
    const editDeviceModel = document.getElementById('editDeviceModel');
    const editIssueDesc = document.getElementById('editIssueDesc');
    const editRepairDate = document.getElementById('editRepairDate');
    const editDeliveryDate = document.getElementById('editDeliveryDate');
    const editStatus = document.getElementById('editStatus');
    const modalSaveBtn = document.getElementById('modalSaveBtn');
    const modalCancelBtn = document.getElementById('modalCancelBtn');
    const editSaveBtn = document.getElementById('editSaveBtn');
    const editCancelBtn = document.getElementById('editCancelBtn');
    const saveEditBtn = document.getElementById('saveEditBtn');
    const cancelEditBtn = document.getElementById('cancelEditBtn');

    // App state
    let jobs = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
    let sales = JSON.parse(localStorage.getItem(LS_SALES) || '[]');
    let inventory = JSON.parse(localStorage.getItem(LS_INVENTORY) || '[]');
    let syncQueue = JSON.parse(localStorage.getItem(LS_QUEUE) || '[]');
    let currentJobId = null;
    let currentTab = 'active'; // active | all

    // Shop info
    const SHOP_NAME = "‡∂¥‡∂≠‡∑í‡∂ª‡∂ú‡∑ö ‡∂â‡∂Ω‡∑ô‡∂ö‡∑ä‡∂ß‡∑ä‚Äç‡∂ª‡∑ú‡∂±‡∑í‡∂ö‡∑ä‡∑É‡∑ä";
    const HOTLINE = "070 607 7 607";

    // BroadcastChannel for same-device multi-tab sync
    let broadcastChannel;
    try {
      broadcastChannel = new BroadcastChannel('repair_jobs_sync');
      broadcastChannel.onmessage = (event) => {
        if (event.data.type === 'UPDATE_JOBS') {
          jobs = event.data.jobs;
          renderJobs(searchInput.value.trim());
        }
      };
    } catch (e) {
      console.warn('BroadcastChannel not supported, fallback to storage event');
    }

    // Helpers
    function setSyncBadge(state) {
      // state: 'online' | 'offline' | 'syncing'
      syncStatus.className = (state === 'online') ? 'sync-online' : (state === 'syncing') ? 'sync-syncing' : 'sync-offline';
      syncStatus.textContent = (state === 'online') ? 'ONLINE' : (state === 'syncing') ? 'SYNCING...' : 'OFFLINE';
    }
    function saveLocalJobs() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(jobs));
      localStorage.setItem(LS_SALES, JSON.stringify(sales));
      localStorage.setItem(LS_INVENTORY, JSON.stringify(inventory));
      localStorage.setItem(LS_QUEUE, JSON.stringify(syncQueue));
      if (broadcastChannel) broadcastChannel.postMessage({ type: 'UPDATE_JOBS', jobs });
    }

    function nowISO() { return new Date().toISOString(); }

    // Queue for offline ops
    function pushQueue(op) {
      syncQueue.push(op);
      localStorage.setItem(LS_QUEUE, JSON.stringify(syncQueue));
    }

    async function flushQueue() {
      if (syncQueue.length === 0) {
        setSyncBadge('online');
        localStorage.setItem(lastSyncKey, new Date().toLocaleString());
        return;
      }
      setSyncBadge('syncing');
      // process in order
      const queueCopy = [...syncQueue];
      for (let i = 0; i < queueCopy.length; i++) {
        const q = queueCopy[i];
        try {
          if (q.table === 'repairs') {
            if (q.type === 'insert') {
              // If local temp id exists, remove before insert to avoid conflict
              const payload = {...q.payload};
              // don't include local id if it's not remote id
              delete payload.id;
              const { data, error } = await supabase.from('repairs').insert(payload).select().single();
              if (error) throw error;
              // replace any local job with that job_number / temp id
              jobs = jobs.map(j => (j.temp_local_id && j.temp_local_id === q.payload.temp_local_id) ? data : j);
              // ensure job has remote id
            } else if (q.type === 'update') {
              const payload = q.payload;
              const id = payload.id;
              if (!id || String(id).length > 12) {
                // likely local temp id -> update by job_number
                await supabase.from('repairs').update(payload.changes).eq('job_number', payload.job_number);
              } else {
                await supabase.from('repairs').update(payload.changes).eq('id', id);
              }
            } else if (q.type === 'delete') {
              await supabase.from('repairs').delete().eq('id', q.payload.id);
            }
          } else if (q.table === 'sales') {
            if (q.type === 'insert') {
              const payload = {...q.payload}; delete payload.id;
              await supabase.from('sales').insert(payload);
            } else if (q.type === 'update') {
              await supabase.from('sales').update(q.payload.changes).eq('id', q.payload.id);
            } else if (q.type === 'delete') {
              await supabase.from('sales').delete().eq('id', q.payload.id);
            }
          } else if (q.table === 'inventory') {
            if (q.type === 'insert') {
              const payload = {...q.payload}; delete payload.id;
              await supabase.from('inventory').insert(payload);
            } else if (q.type === 'update') {
              await supabase.from('inventory').update(q.payload.changes).eq('id', q.payload.id);
            } else if (q.type === 'delete') {
              await supabase.from('inventory').delete().eq('id', q.payload.id);
            }
          }
          // success - remove the processed head of queue
          syncQueue.shift();
          localStorage.setItem(LS_QUEUE, JSON.stringify(syncQueue));
        } catch (err) {
          console.error('Queue flush error', err, q);
          setSyncBadge('offline');
          return; // stop processing further and try later
        }
      }
      // finished
      setSyncBadge('online');
      localStorage.setItem(lastSyncKey, new Date().toLocaleString());
      saveLocalJobs();
    }

    // Realtime handling
    async function subscribeRealtime() {
      try {
        // create channels for each table
        await supabase.channel('public:repairs').on('postgres_changes', { event: '*', schema: 'public', table: 'repairs' }, payload => {
          // payload.eventType: INSERT, UPDATE, DELETE
          handleRemoteChange('repairs', payload);
        }).subscribe();

        await supabase.channel('public:sales').on('postgres_changes', { event: '*', schema: 'public', table: 'sales' }, payload => {
          handleRemoteChange('sales', payload);
        }).subscribe();

        await supabase.channel('public:inventory').on('postgres_changes', { event: '*', schema: 'public', table: 'inventory' }, payload => {
          handleRemoteChange('inventory', payload);
        }).subscribe();
      } catch (err) {
        console.warn('Realtime subscribe failed', err);
      }
    }

    function handleRemoteChange(table, payload) {
      const evt = payload.eventType || payload.event;
      const recordNew = payload.new || payload.record || payload.new;
      const recordOld = payload.old || payload.old;
      if (table === 'repairs') {
        if (evt === 'INSERT') {
          // ensure not duplicate
          jobs = [recordNew, ...jobs.filter(j => j.id !== recordNew.id)];
        } else if (evt === 'UPDATE') {
          jobs = jobs.map(j => (j.id === recordNew.id || j.job_number === recordNew.job_number) ? recordNew : j);
        } else if (evt === 'DELETE') {
          jobs = jobs.filter(j => j.id !== recordOld.id);
        }
      } else if (table === 'sales') {
        if (evt === 'INSERT') sales = [recordNew, ...sales.filter(s => s.id !== recordNew.id)];
        else if (evt === 'UPDATE') sales = sales.map(s => s.id === recordNew.id ? recordNew : s);
        else if (evt === 'DELETE') sales = sales.filter(s => s.id !== recordOld.id);
      } else if (table === 'inventory') {
        if (evt === 'INSERT') inventory = [recordNew, ...inventory.filter(i => i.id !== recordNew.id)];
        else if (evt === 'UPDATE') inventory = inventory.map(i => i.id === recordNew.id ? recordNew : i);
        else if (evt === 'DELETE') inventory = inventory.filter(i => i.id !== recordOld.id);
      }
      saveLocalJobs();
      renderJobs();
      localStorage.setItem(lastSyncKey, new Date().toLocaleString());
      setSyncBadge('online');
    }

    // Load from Supabase (initial)
    async function loadFromCloud() {
      setSyncBadge('syncing');
      try {
        const { data:repData, error:repErr } = await supabase.from('repairs').select('*').order('id',{ascending:false}).limit(1000);
        if (!repErr && repData) jobs = repData;
      } catch (e) { console.warn('Load repairs failed', e); }

      try {
        const { data:salesData, error:salesErr } = await supabase.from('sales').select('*').order('id',{ascending:false}).limit(1000);
        if (!salesErr && salesData) sales = salesData;
      } catch (e) { console.warn('Load sales failed', e); }

      try {
        const { data:invData, error:invErr } = await supabase.from('inventory').select('*').order('id',{ascending:false}).limit(1000);
        if (!invErr && invData) inventory = invData;
      } catch (e) { console.warn('Load inventory failed', e); }

      saveLocalJobs();
      localStorage.setItem(lastSyncKey, new Date().toLocaleString());
      setSyncBadge('online');
    }

    // ---------- Render UI (keeps original look) ----------
    function renderJobs(filter='') {
      jobListEl.innerHTML = '';
      if (!jobs || jobs.length === 0) {
        jobListEl.innerHTML = '<p>No jobs yet. Add your first repair!</p>';
        return;
      }

      let filteredJobs = jobs.slice();

      if (currentTab === 'active') filteredJobs = filteredJobs.filter(j => j.status !== 'Delivered');

      if (filter) {
        const term = filter.toLowerCase();
        filteredJobs = filteredJobs.filter(job =>
          (job.customerName || job.customer_name || '').toString().toLowerCase().includes(term) ||
          (job.customerPhone || job.customer_phone || '').toString().includes(term) ||
          ((job.jobNumber || job.job_number || '')).toString().toLowerCase().includes(term)
        );
      }

      filteredJobs.sort((a,b) => {
        // prefer remote id order; fallback to createdAt / id
        const ta = new Date(a.createdAt || a.created_at || 0).getTime() || Number(a.id||0);
        const tb = new Date(b.createdAt || b.created_at || 0).getTime() || Number(b.id||0);
        return tb - ta;
      });

      if (filteredJobs.length === 0) {
        jobListEl.innerHTML = `<p>‚ùå No ${currentTab} jobs found.</p>`;
        return;
      }

      filteredJobs.forEach(job => {
        const repairPrice = Number(job.repairPrice || job.repair_price || 0);
        const amountPaid = Number(job.amountPaid || job.amount_paid || 0);
        const balance = repairPrice - amountPaid;

        let paymentStatus = "Unpaid", paymentClass = "unpaid";
        if (balance <= 0 && repairPrice > 0) { paymentStatus = "Paid"; paymentClass = "paid"; }
        else if (amountPaid > 0) { paymentStatus = "Partial"; paymentClass = "partial"; }

        const jobEl = document.createElement('div');
        jobEl.className = 'job';
        const customerName = job.customerName || job.customer_name || '';
        const customerPhone = job.customerPhone || job.customer_phone || '';
        const customerAddress = job.customerAddress || job.customer_address || '';
        const deviceBrand = job.deviceBrand || job.device_brand || '';
        const deviceModel = job.deviceModel || job.device_model || '';
        const issueDesc = job.issueDesc || job.issue_desc || '';
        const status = job.status || 'Pending';
        const jobNumber = job.jobNumber || job.job_number || '';

        jobEl.innerHTML = `
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <strong>üë®‚Äçüîß ${customerName}</strong>
            <span class="job-number">${jobNumber}</span>
          </div>
          <strong>üìû ${customerPhone}</strong><br>
          <strong>üè† Address:</strong> ${customerAddress || 'N/A'}<br>
          <strong>üì± ${deviceBrand} ${deviceModel}</strong><br>
          <strong>‚ùó Issue:</strong> ${issueDesc || 'N/A'}<br>
          <strong>üìÖ Received:</strong> ${job.repairDate || job.repair_date || ''} | <strong>üöö Expected:</strong> ${job.deliveryDate || job.delivery_date || ''}<br>
          <strong>üè∑Ô∏è Status:</strong>
          <span class="job-status ${status==='Delivered'?'delivered':status==='Ready for Pickup'?'ready':status==='In Progress'?'progress':'pending'}">
            ${status}
          </span><br>
          <strong>üí∞ Price: ${formatLKR(repairPrice)} | Paid: ${formatLKR(amountPaid)} | Due: ${formatLKR(balance)}</strong><br>
          <strong>üí≥ Payment:</strong> <span class="payment-status ${paymentClass}">${paymentStatus}</span><br>
          <small>üíæ Saved: ${job.createdAt || job.created_at || ''}</small>
          <div class="job-actions" style="margin-top:10px; display:flex; flex-wrap:wrap; gap:5px;"></div>
          <hr>
        `;

        const actionsContainer = jobEl.querySelector('.job-actions');

        // Complete Job Button
        if (status !== 'Delivered' && status !== 'Ready for Pickup') {
          const completeBtn = document.createElement('button');
          completeBtn.className = 'complete-btn';
          completeBtn.textContent = '‚úÖ Complete Repair';
          completeBtn.addEventListener('click', () => {
            currentJobId = job.jobNumber || job.job_number || job.id;
            modalPrice.value = repairPrice || '';
            modalPaid.value = amountPaid || '';
            completeModal.style.display = 'flex';
            modalPrice.focus();
            // store id in modal via dataset
            completeModal.dataset.jobId = job.id || job.job_number || job.jobNumber;
          });
          actionsContainer.appendChild(completeBtn);
        }

        // Mark as Delivered
        if (status === 'Ready for Pickup') {
          const deliverBtn = document.createElement('button');
          deliverBtn.className = 'deliver-btn';
          deliverBtn.textContent = 'üì¶ Mark as Delivered';
          deliverBtn.addEventListener('click', async () => {
            const found = jobs.find(j => (j.jobNumber || j.job_number || j.id) === jobNumber || j.id === job.id);
            if (!found) return alert('Job not found locally');
            const bal = (Number(found.repairPrice || found.repair_price || 0) - Number(found.amountPaid || found.amount_paid || 0));
            if (bal > 0) return alert("‚ö†Ô∏è Cannot mark as Delivered until full payment is received.");
            // update status
            found.status = 'Delivered';
            found.updated_at = nowISO();
            await updateJob(found);
            // send SMS
            const dsms = generateDeliveredSMSText(found.customerName || found.customer_name, found.jobNumber || found.job_number, found.repairPrice||found.repair_price, found.amountPaid||found.amount_paid);
            sendSMS(found.customerPhone || found.customer_phone, dsms);
            alert(`‚úÖ Job ${found.jobNumber||found.job_number||found.id} marked as DELIVERED. SMS opened.`);
          });
          actionsContainer.appendChild(deliverBtn);
        }

        // Edit Price & Payment
        const editPaymentBtn = document.createElement('button');
        editPaymentBtn.className = 'edit-payment-btn';
        editPaymentBtn.textContent = '‚úèÔ∏è Edit Price & Payment';
        editPaymentBtn.addEventListener('click', () => {
          currentJobId = job.jobNumber || job.job_number || job.id;
          editPrice.value = repairPrice || '';
          editPaid.value = amountPaid || '';
          paymentModal.style.display = 'flex';
          paymentModal.dataset.jobId = job.jobNumber || job.job_number || job.id;
        });
        actionsContainer.appendChild(editPaymentBtn);

        // Edit Job Details
        const editBtn = document.createElement('button');
        editBtn.className = 'edit-btn';
        editBtn.textContent = 'üìù Edit Job Details';
        editBtn.addEventListener('click', () => {
          currentJobId = job.jobNumber || job.job_number || job.id;
          // fill edit modal fields from job
          editJobId.value = job.id || '';
          editJobNumber.value = job.jobNumber || job.job_number || '';
          editCustomerName.value = job.customerName || job.customer_name || '';
          editCustomerPhone.value = job.customerPhone || job.customer_phone || '';
          editCustomerAddress.value = job.customerAddress || job.customer_address || '';
          editDeviceBrand.value = job.deviceBrand || job.device_brand || '';
          editDeviceModel.value = job.deviceModel || job.device_model || '';
          editIssueDesc.value = job.issueDesc || job.issue_desc || '';
          editRepairDate.value = job.repairDate || job.repair_date || '';
          editDeliveryDate.value = job.deliveryDate || job.delivery_date || '';
          editStatus.value = status;
          editJobModal.style.display = 'flex';
          editCustomerName.focus();
        });
        actionsContainer.appendChild(editBtn);

        // Send SMS
        const smsBtn = document.createElement('button');
        smsBtn.className = 'sms-btn';
        smsBtn.textContent = 'üì≤ Send SMS Update';
        if (!customerPhone) { smsBtn.disabled = true; smsBtn.style.opacity = 0.5; }
        smsBtn.addEventListener('click', () => {
          const smsText = generateDetailedSMSText({
            customerName: job.customerName || job.customer_name,
            customerPhone: job.customerPhone || job.customer_phone,
            deviceBrand: job.deviceBrand || job.device_brand,
            deviceModel: job.deviceModel || job.device_model,
            status: job.status || job.status,
            repairPrice: job.repairPrice || job.repair_price,
            amountPaid: job.amountPaid || job.amount_paid,
            jobNumber: job.jobNumber || job.job_number
          });
          sendSMS(customerPhone, smsText);
        });
        actionsContainer.appendChild(smsBtn);

        // Receipt
        const receiptBtn = document.createElement('button');
        receiptBtn.className = 'receipt-btn';
        receiptBtn.textContent = 'üßæ Print Receipt';
        receiptBtn.addEventListener('click', () => {
          const html = generateReceiptHTML({
            jobNumber: job.jobNumber || job.job_number,
            customerName: customerName,
            customerPhone: customerPhone,
            customerAddress: customerAddress,
            deviceBrand: deviceBrand,
            deviceModel: deviceModel,
            issueDesc: issueDesc,
            status: status,
            repairPrice: repairPrice,
            amountPaid: amountPaid
          });
          receiptContent.innerHTML = `<pre style="white-space: pre-wrap; word-wrap: break-word; margin:0;">${html}</pre>`;
          setTimeout(()=>{ window.print(); }, 150);
        });
        actionsContainer.appendChild(receiptBtn);

        jobListEl.appendChild(jobEl);
      });
    }

    // ---------- CRUD operations connected to Supabase ----------
    // Helper to create job object consistent format
    function normalizeJobFromForm() {
      return {
        jobNumber: generateJobNumber(),
        customerName: document.getElementById('customerName').value.trim(),
        customerPhone: document.getElementById('customerPhone').value.trim(),
        customerAddress: document.getElementById('customerAddress').value.trim(),
        deviceBrand: document.getElementById('deviceBrand').value.trim(),
        deviceModel: document.getElementById('deviceModel').value.trim(),
        issueDesc: document.getElementById('issueDesc').value.trim(),
        repairPrice: 0,
        amountPaid: 0,
        repairDate: document.getElementById('repairDate').value || null,
        deliveryDate: document.getElementById('deliveryDate').value || null,
        status: document.getElementById('status').value || 'Pending',
        createdAt: new Date().toLocaleString()
      };
    }

    // Save job (insert)
    saveBtn.addEventListener('click', async () => {
      const job = normalizeJobFromForm();
      if (!job.customerName || !job.customerPhone || !job.deviceModel) {
        alert("‚ö†Ô∏è Please fill Customer Name, Phone, and Device Model!");
        return;
      }

      // If online, insert to Supabase and use returned record
      if (navigator.onLine) {
        try {
          const payload = {
            job_number: job.jobNumber,
            customer_name: job.customerName,
            customer_phone: job.customerPhone,
            customer_address: job.customerAddress,
            device_brand: job.deviceBrand,
            device_model: job.deviceModel,
            issue_desc: job.issueDesc,
            repair_price: job.repairPrice,
            amount_paid: job.amountPaid,
            repair_date: job.repairDate,
            delivery_date: job.deliveryDate,
            status: job.status,
            created_at: new Date().toISOString()
          };
          const { data, error } = await supabase.from('repairs').insert(payload).select().single();
          if (error) throw error;
          // add to local jobs (uses remote id)
          jobs.unshift({
            id: data.id,
            jobNumber: data.job_number,
            customerName: data.customer_name,
            customerPhone: data.customer_phone,
            customerAddress: data.customer_address,
            deviceBrand: data.device_brand,
            deviceModel: data.device_model,
            issueDesc: data.issue_desc,
            repairPrice: data.repair_price,
            amountPaid: data.amount_paid,
            repairDate: data.repair_date,
            deliveryDate: data.delivery_date,
            status: data.status,
            createdAt: data.created_at
          });
          saveLocalJobs();
          renderJobs();
          // open SMS
          const receivedSMS = generateReceivedSMSText(job.customerName, job.deviceBrand, job.deviceModel, job.jobNumber);
          sendSMS(job.customerPhone, receivedSMS);
          alert(`‚úÖ Repair Job ${job.jobNumber} Saved & SMS opened.`);
          resetForm();
          localStorage.setItem(lastSyncKey, new Date().toLocaleString());
          setSyncBadge('online');
        } catch (err) {
          console.error('Insert to Supabase failed', err);
          // fallback to local queue
          job.temp_local_id = Date.now();
          jobs.unshift(job);
          pushQueue({ type:'insert', table:'repairs', payload: job });
          saveLocalJobs();
          renderJobs();
          alert('Saved locally. Will sync when online.');
          setSyncBadge('offline');
        }
      } else {
        // offline -> queue local insert
        job.temp_local_id = Date.now();
        jobs.unshift(job);
        pushQueue({ type:'insert', table:'repairs', payload: job });
        saveLocalJobs();
        renderJobs();
        alert('Saved locally. Will sync when online.');
        setSyncBadge('offline');
        resetForm();
      }
    });

    // Update job generic
    async function updateJob(job) {
      // ensure fields names match remote table
      const payload = {
        customer_name: job.customerName || job.customer_name,
        customer_phone: job.customerPhone || job.customer_phone,
        customer_address: job.customerAddress || job.customer_address,
        device_brand: job.deviceBrand || job.device_brand,
        device_model: job.deviceModel || job.device_model,
        issue_desc: job.issueDesc || job.issue_desc,
        repair_price: job.repairPrice || job.repair_price,
        amount_paid: job.amountPaid || job.amount_paid,
        repair_date: job.repairDate || job.repair_date,
        delivery_date: job.deliveryDate || job.delivery_date,
        status: job.status,
        updated_at: new Date().toISOString()
      };

      // update local
      jobs = jobs.map(j => {
        if ((j.jobNumber || j.job_number || j.id) === (job.jobNumber || job.job_number || job.id)) return {...j, ...job};
        return j;
      });
      saveLocalJobs();
      renderJobs();

      // if online try remote update
      if (navigator.onLine) {
        try {
          if (job.id && Number(job.id)) {
            await supabase.from('repairs').update(payload).eq('id', job.id);
          } else if (job.jobNumber || job.job_number) {
            await supabase.from('repairs').update(payload).eq('job_number', job.jobNumber || job.job_number);
          } else {
            // fallback queue
            pushQueue({ type:'update', table:'repairs', payload:{ id: job.id, job_number: job.jobNumber, changes: payload } });
            setSyncBadge('offline');
          }
          localStorage.setItem(lastSyncKey, new Date().toLocaleString());
          setSyncBadge('online');
        } catch (err) {
          console.error('Update remote failed', err);
          pushQueue({ type:'update', table:'repairs', payload:{ id: job.id, job_number: job.jobNumber, changes: payload } });
          setSyncBadge('offline');
        }
      } else {
        pushQueue({ type:'update', table:'repairs', payload:{ id: job.id, job_number: job.jobNumber, changes: payload } });
        setSyncBadge('offline');
      }
    }

    // Delete job (used if you implement)
    async function deleteJob(job) {
      jobs = jobs.filter(j => j.jobNumber !== job.jobNumber && j.job_number !== job.jobNumber && j.id !== job.id);
      saveLocalJobs();
      if (navigator.onLine && job.id) {
        try { await supabase.from('repairs').delete().eq('id', job.id); }
        catch(e) { pushQueue({ type:'delete', table:'repairs', payload:{ id: job.id } }); setSyncBadge('offline'); }
      } else {
        pushQueue({ type:'delete', table:'repairs', payload:{ id: job.id } });
        setSyncBadge('offline');
      }
      renderJobs();
    }

    // ---------- Modal actions ----------
    modalSaveBtn.addEventListener('click', async () => {
      const jobKey = completeModal.dataset.jobId;
      const price = parseFloat(modalPrice.value) || 0;
      const paid = parseFloat(modalPaid.value) || 0;
      // find job by jobNumber or id
      const job = jobs.find(j => (j.jobNumber===jobKey || j.job_number===jobKey || String(j.id)===String(jobKey) || j.temp_local_id==jobKey));
      if (!job) { alert('Job not found'); completeModal.style.display='none'; return; }
      job.repairPrice = price;
      job.amountPaid = paid;
      job.status = 'Ready for Pickup';
      job.updated_at = new Date().toISOString();
      await updateJob(job);
      // send ready SMS
      const readySMS = generateReadySMSText(job.customerName || job.customer_name, job.jobNumber || job.job_number, job.repairPrice || job.repair_price, job.amountPaid || job.amount_paid);
      sendSMS(job.customerPhone || job.customer_phone, readySMS);
      alert('üéâ Job marked as READY FOR PICKUP! SMS opened.');
      completeModal.style.display = 'none';
    });
    modalCancelBtn.addEventListener('click', ()=> completeModal.style.display='none');

    editSaveBtn.addEventListener('click', async () => {
      const jobKey = editJobNumber.value || editJobId.value;
      const job = jobs.find(j => (j.jobNumber===jobKey || j.job_number===jobKey || String(j.id)===String(jobKey)));
      if (!job) { alert('Job not found'); editJobModal.style.display='none'; return; }
      job.customerName = editCustomerName.value.trim();
      job.customerPhone = editCustomerPhone.value.trim();
      job.customerAddress = editCustomerAddress.value.trim();
      job.deviceBrand = editDeviceBrand.value.trim();
      job.deviceModel = editDeviceModel.value.trim();
      job.issueDesc = editIssueDesc.value.trim();
      job.repairDate = editRepairDate.value;
      job.deliveryDate = editDeliveryDate.value;
      const newStatus = editStatus.value;
      // validate
      if (!job.customerName || !job.customerPhone || !job.deviceModel) {
        alert("‚ö†Ô∏è Please fill Customer Name, Phone, and Device Model!");
        return;
      }
      // delivered validation
      if (newStatus === "Delivered") {
        const balance = Number(job.repairPrice || job.repair_price || 0) - Number(job.amountPaid || job.amount_paid || 0);
        if (balance > 0) {
          alert("‚ö†Ô∏è Cannot set status to 'Delivered' until full payment is received.");
          return;
        }
        const deliveredSMS = generateDeliveredSMSText(job.customerName, job.jobNumber || job.job_number, job.repairPrice || job.repair_price, job.amountPaid || job.amount_paid);
        sendSMS(job.customerPhone, deliveredSMS);
        alert(`‚úÖ Job marked as DELIVERED. SMS opened.`);
      }
      job.status = newStatus;
      job.updated_at = new Date().toISOString();
      await updateJob(job);
      editJobModal.style.display='none';
    });
    editCancelBtn.addEventListener('click', ()=> paymentModal.style.display='none');
    cancelEditBtn.addEventListener('click', ()=> editJobModal.style.display='none');

    // Edit payment modal save
    document.getElementById('editSaveBtn').addEventListener('click', async () => {
      const jobKey = paymentModal.dataset.jobId;
      const job = jobs.find(j => (j.jobNumber===jobKey || j.job_number===jobKey || String(j.id)===String(jobKey)));
      if (!job) { alert('Job not found'); paymentModal.style.display='none'; return; }
      const price = parseFloat(editPrice.value) || 0;
      const paid = parseFloat(editPaid.value) || 0;
      job.repairPrice = price;
      job.amountPaid = paid;
      job.updated_at = nowISO();
      await updateJob(job);
      alert('‚úÖ Price & Payment updated!');
      paymentModal.style.display='none';
    });

    // ---------- Search / Tabs / Export ----------
    tabs.forEach(tab => {
      tab.addEventListener('click', ()=> {
        tabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        currentTab = tab.dataset.tab;
        renderJobs(searchInput.value.trim());
      });
    });

    exportBtn.addEventListener('click', () => {
      if (!jobs || jobs.length === 0) { alert('No jobs to export!'); return; }
      const dataStr = JSON.stringify(jobs, null, 2);
      const blob = new Blob([dataStr], { type:'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'pathirage-electronics-jobs-' + new Date().toISOString().slice(0,10) + '.json';
      document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
    });

    searchBtn.addEventListener('click', ()=> renderJobs(searchInput.value.trim()));
    searchInput.addEventListener('keyup', (e)=> { if (e.key === 'Enter') searchBtn.click(); });
    clearSearchBtn.addEventListener('click', ()=> { searchInput.value=''; renderJobs(''); });

    // storage event for cross-tab
    window.addEventListener('storage', (e)=> {
      if (e.key === STORAGE_KEY) {
        jobs = JSON.parse(e.newValue || '[]');
        renderJobs(searchInput.value.trim());
      }
      if (e.key === LS_QUEUE) {
        syncQueue = JSON.parse(e.newValue || '[]');
      }
    });

    // ---------- Printing/SMS/Receipt helpers (kept from original) ----------
    function sendSMS(phone, text) {
      if (!phone) { alert("‚ö†Ô∏è No phone number to send SMS!"); return; }
      const encodedText = encodeURIComponent(text);
      const smsUrl = `sms:${phone}?body=${encodedText}`;
      window.location.href = smsUrl;
    }
    function formatLKR(amount) {
      return new Intl.NumberFormat('si-LK', { style:'currency', currency:'LKR', minimumFractionDigits:2 }).format(Number(amount || 0));
    }
    function generateReceivedSMSText(customerName, deviceBrand, deviceModel, jobNumber) {
      return `‡∂Ü‡∂∫‡∑î‡∂∂‡∑ù‡∑Ä‡∂±‡∑ä ${customerName},\n\n${SHOP_NAME} ‡∂≠‡∑ù‡∂ª‡∑è‡∂ú‡∑ê‡∂±‡∑ì‡∂∏‡∂ß ‡∑É‡∑ä‡∂≠‡∑ñ‡∂≠‡∑í‡∂∫‡∑í!\n‡∂î‡∂∂‡∑ö ${deviceBrand} ${deviceModel} ‡∂ã‡∂¥‡∑è‡∂Ç‡∂ú‡∂∫ ‡∂Ö‡∂Ω‡∑î‡∂≠‡∑ä‡∑Ä‡∑ê‡∂©‡∑í‡∂∫‡∑è ‡∑É‡∂≥‡∑Ñ‡∑è ‡∂Ö‡∂¥ ‡∑Ä‡∑ô‡∂≠ ‡∂Ω‡∑ê‡∂∂‡∑ì ‡∂á‡∂≠.\n\nüìå ‡∂î‡∂∂‡∑ö ‡∂ª‡∑ê‡∂ö‡∑í‡∂∫‡∑è ‡∂Ö‡∂Ç‡∂ö‡∂∫: ${jobNumber}\n‚òéÔ∏è ‡∑Ñ‡∑ú‡∂ß‡∑ä‡∂Ω‡∂∫‡∑í‡∂±‡∑ä: ${HOTLINE}\n\n‚Äî ${SHOP_NAME}`;
    }
    function generateReadySMSText(customerName, jobNumber, repairPrice, amountPaid) {
      const balance = (Number(repairPrice)||0) - (Number(amountPaid)||0);
      return `‡∂Ü‡∂∫‡∑î‡∂∂‡∑ù‡∑Ä‡∂±‡∑ä ${customerName},\n\nüéâ ‡∂¥‡∑î‡∂Ø‡∑î‡∂∏ ‡∂¥‡∂´‡∑í‡∑Ä‡∑í‡∂©‡∂∫‡∂ö‡∑ä! ‡∂î‡∂∂‡∑ö ‡∂ã‡∂¥‡∑è‡∂Ç‡∂ú‡∂∫ ${SHOP_NAME} ‡∑Ñ‡∑í ‡∂∑‡∑è‡∂ª ‡∂ú‡∑ê‡∂±‡∑ì‡∂∏‡∂ß ‡∑É‡∑ñ‡∂Ø‡∑è‡∂±‡∂∏‡∑ä!\n\nüìå ‡∂ª‡∑ê‡∂ö‡∑í‡∂∫‡∑è ‡∂Ö‡∂Ç‡∂ö‡∂∫: ${jobNumber}\nüí∞ ‡∂Ö‡∂Ω‡∑î‡∂≠‡∑ä‡∑Ä‡∑ê‡∂©‡∑í‡∂∫‡∑è ‡∂∏‡∑í‡∂Ω: Rs ${Number(repairPrice||0).toFixed(2)}\nüíµ ‡∂ú‡∑ô‡∑Ä‡∑ñ ‡∂∏‡∑î‡∂Ø‡∂Ω: Rs ${Number(amountPaid||0).toFixed(2)}\nüí≥ ‡∂ú‡∑ô‡∑Ä‡∑í‡∂∫ ‡∂∫‡∑î‡∂≠‡∑î ‡∑Å‡∑ö‡∑Ç‡∂∫: Rs ${balance.toFixed(2)}\n\n‚òéÔ∏è ‡∑Ñ‡∑ú‡∂ß‡∑ä‡∂Ω‡∂∫‡∑í‡∂±‡∑ä: ${HOTLINE}\n‚Äî ${SHOP_NAME}`;
    }
    function generateDeliveredSMSText(customerName, jobNumber, repairPrice, amountPaid) {
      const balance = (Number(repairPrice)||0) - (Number(amountPaid)||0);
      return `‡∂Ü‡∂∫‡∑î‡∂∂‡∑ù‡∑Ä‡∂±‡∑ä ${customerName},\n\n‚úÖ ‡∂î‡∂∂‡∑ö ‡∂ã‡∂¥‡∑è‡∂Ç‡∂ú‡∂∫ ${SHOP_NAME} ‡∑Ä‡∑ô‡∂≠‡∑í‡∂±‡∑ä ‡∑É‡∑è‡∂ª‡∑ä‡∂Æ‡∂ö‡∑Ä ‡∂∑‡∑è‡∂ª ‡∂Ø‡∑ì ‡∂á‡∂≠!\n\nüìå ‡∂ª‡∑ê‡∂ö‡∑í‡∂∫‡∑è ‡∂Ö‡∂Ç‡∂ö‡∂∫: ${jobNumber}\nüí∞ ‡∑É‡∂∏‡∑ä‡∂¥‡∑ñ‡∂ª‡∑ä‡∂´ ‡∂∏‡∑î‡∂Ø‡∂Ω: Rs ${Number(repairPrice||0).toFixed(2)}\nüíµ ‡∂ú‡∑ô‡∑Ä‡∑ñ ‡∂∏‡∑î‡∂Ø‡∂Ω: Rs ${Number(amountPaid||0).toFixed(2)}\n${balance > 0 ? `üí≥ ‡∑Å‡∑ö‡∑Ç‡∂∫: Rs ${balance.toFixed(2)}` : '‚úÖ ‡∑É‡∂∏‡∑ä‡∂¥‡∑ñ‡∂ª‡∑ä‡∂´‡∂∫‡∑ô‡∂±‡∑ä ‡∂ú‡∑ô‡∑Ä‡∑è ‡∂á‡∂≠'}\n\n‚òéÔ∏è ‡∑Ñ‡∑ú‡∂ß‡∑ä‡∂Ω‡∂∫‡∑í‡∂±‡∑ä: ${HOTLINE}\n\n‚Äî ${SHOP_NAME}`;
    }
    function generateDetailedSMSText(job) {
      const balance = (Number(job.repairPrice || job.repair_price || 0) - Number(job.amountPaid || job.amount_paid || 0));
      let msg = `‡∂Ü‡∂∫‡∑î‡∂∂‡∑ù‡∑Ä‡∂±‡∑ä ${job.customerName || job.customer_name},\n\n`;
      msg += `üìå ‡∂ª‡∑ê‡∂ö‡∑í‡∂∫‡∑è ‡∂Ö‡∂Ç‡∂ö‡∂∫: ${job.jobNumber || job.job_number}\n`;
      msg += `${SHOP_NAME} ‡∂≠‡∑ù‡∂ª‡∑è‡∂ú‡∑ê‡∂±‡∑ì‡∂∏‡∂ß ‡∑É‡∑ä‡∂≠‡∑ñ‡∂≠‡∑í‡∂∫‡∑í!\n`;
      msg += `‡∂ã‡∂¥‡∑è‡∂Ç‡∂ú‡∂∫: ${job.deviceBrand || job.device_brand} ${job.deviceModel || job.device_model}\n`;
      msg += `‡∂≠‡∂≠‡∑ä‡∂≠‡∑ä‡∑Ä‡∂∫: ${job.status}\n`;
      msg += `‡∂Ö‡∂Ω‡∑î‡∂≠‡∑ä‡∑Ä‡∑ê‡∂©‡∑í‡∂∫‡∑è ‡∂∏‡∑í‡∂Ω: Rs ${Number(job.repairPrice||job.repair_price||0).toFixed(2)}\n`;
      msg += `‡∂ú‡∑ô‡∑Ä‡∑ñ ‡∂∏‡∑î‡∂Ø‡∂Ω: Rs ${Number(job.amountPaid||job.amount_paid||0).toFixed(2)}\n`;
      msg += `‡∑Å‡∑ö‡∑Ç‡∂∫: Rs ${balance.toFixed(2)}\n\n`;
      msg += `üìç ‡∂î‡∂∂‡∑ö ‡∂ã‡∂¥‡∑è‡∂Ç‡∂ú‡∂∫ ‡∂∑‡∑è‡∂ª ‡∂ú‡∑ê‡∂±‡∑ì‡∂∏‡∂ß ‡∂Ö‡∂¥ ‡∑Ä‡∑ô‡∂≠ ‡∂¥‡∑ê‡∂∏‡∑í‡∂´‡∑ô‡∂±‡∑ä‡∂±.\n`;
      msg += `‚òéÔ∏è ‡∑É‡∂∏‡∑ä‡∂∂‡∂±‡∑ä‡∂∞ ‡∑Ä‡∂±‡∑ä‡∂±: ${HOTLINE}\n‚Äî ${SHOP_NAME}`;
      return msg;
    }
    function generateReceiptHTML(job) {
      const balance = (Number(job.repairPrice||job.repair_price||0) - Number(job.amountPaid||job.amount_paid||0));
      const now = new Date().toLocaleString();
      return `
[ ${SHOP_NAME} ]
‡∂Ø‡∑î‡∂ª‡∂ö‡∂Æ‡∂±: ${HOTLINE}
‡∂Ö‡∂Ω‡∑î‡∂≠‡∑ä‡∑Ä‡∑ê‡∂©‡∑í‡∂∫‡∑è ‡∂∂‡∑í‡∂Ω‡∑ä‡∂¥‡∂≠
----------------
‡∂ª‡∑ê‡∂ö‡∑í‡∂∫‡∑è ‡∂Ö‡∂Ç‡∂ö‡∂∫ : ${job.jobNumber || job.job_number}
‡∂Ø‡∑í‡∂±‡∂∫       : ${now}
‡∂¥‡∑è‡∂ª‡∑í‡∂∑‡∑ù‡∂ú‡∑í‡∂ö‡∂∫‡∑è: ${job.customerName || job.customer_name}
‡∂Ø‡∑î‡∂ª‡∂ö‡∂Æ‡∂±‡∂∫   : ${job.customerPhone || job.customer_phone}
‡∂Ω‡∑í‡∂¥‡∑í‡∂±‡∂∫     : ${job.customerAddress || job.customer_address || '‚Äî'}

‡∂ã‡∂¥‡∑è‡∂Ç‡∂ú‡∂∫     : ${job.deviceBrand || job.device_brand} ${job.deviceModel || job.device_model}
‡∂ú‡∑ê‡∂ß‡∑Ö‡∑î‡∑Ä     : ${job.issueDesc || job.issue_desc || '‚Äî'}
‡∂≠‡∂≠‡∑ä‡∂≠‡∑ä‡∑Ä‡∂∫     : ${job.status}

----------------
‡∂Ö‡∂Ω‡∑î.‡∂∏‡∑í‡∂Ω    : ${formatLKR(job.repairPrice || job.repair_price || 0)}
‡∂ú‡∑ô‡∑Ä‡∑ñ ‡∂∏‡∑î‡∂Ø‡∂Ω  : ${formatLKR(job.amountPaid || job.amount_paid || 0)}
‡∑Å‡∑ö‡∑Ç‡∂∫       : ${formatLKR(balance)}
----------------

‡∂∏‡∑ô‡∂∏ ‡∂∂‡∑í‡∂Ω‡∑ä‡∂¥‡∂≠ ‡∂ª‡∂≥‡∑Ä‡∑è ‡∂ú‡∂±‡∑ä‡∂±.

----------------
   ‡∂Ö‡∂≠‡∑ä‡∑É‡∂±
----------------
`;
    }

    function resetForm() {
      document.getElementById('customerName').value = '';
      document.getElementById('customerPhone').value = '';
      document.getElementById('customerAddress').value = '';
      document.getElementById('deviceBrand').value = '';
      document.getElementById('deviceModel').value = '';
      document.getElementById('issueDesc').value = '';
      document.getElementById('status').value = 'Pending';
      document.getElementById('repairDate').valueAsDate = new Date();
      document.getElementById('deliveryDate').valueAsDate = new Date(Date.now() + 86400000 * 3);
    }

    // generate next job number from local list (safe)
    function generateJobNumber() {
      const year = new Date().getFullYear();
      let nextNumber = 1;
      const currentYearJobs = (jobs||[]).filter(job => (job.jobNumber || job.job_number || '').startsWith(`PE-${year}-`));
      if (currentYearJobs.length > 0) {
        const numbers = currentYearJobs.map(job => {
          const parts = (job.jobNumber || job.job_number || '').split('-');
          return parseInt(parts[2]) || 0;
        });
        nextNumber = Math.max(...numbers) + 1;
      }
      return `PE-${year}-${nextNumber.toString().padStart(4,'0')}`;
    }

    // ---------- Start-up: load local, then cloud, setup realtime ----------
    (async function init() {
      // set defaults for date inputs
      try { document.getElementById('repairDate').valueAsDate = new Date(); } catch(e){}
      try { document.getElementById('deliveryDate').valueAsDate = new Date(Date.now() + 86400000 * 3); } catch(e){}

      // load local fallback copies (keeps previous behavior)
      jobs = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
      sales = JSON.parse(localStorage.getItem(LS_SALES) || '[]');
      inventory = JSON.parse(localStorage.getItem(LS_INVENTORY) || '[]');
      syncQueue = JSON.parse(localStorage.getItem(LS_QUEUE) || '[]');

      // render local immediately
      renderJobs();

      // Attempt cloud connection
      if (navigator.onLine) {
        try {
          await loadFromCloud();
          await subscribeRealtime();
          await flushQueue();
          setSyncBadge('online');
        } catch (err) {
          console.warn('Cloud init failed', err);
          setSyncBadge('offline');
        }
      } else {
        setSyncBadge('offline');
      }

      // network events
      window.addEventListener('online', async () => {
        setSyncBadge('syncing');
        try {
          await flushQueue();
          await loadFromCloud();
          await subscribeRealtime();
          setSyncBadge('online');
        } catch (e) {
          console.warn('Online handler error', e);
          setSyncBadge('offline');
        }
      });
      window.addEventListener('offline', () => setSyncBadge('offline'));
    })();

    // Expose some utilities for debugging in console
    window._pos = { jobs, sales, inventory, syncQueue, flushQueue, supabase };

    </script>
</body>
</html>

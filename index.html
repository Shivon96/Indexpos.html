<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>POS - Supabase Sync + SMS + Print</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    /* Basic layout */
    body { font-family: Arial, sans-serif; margin: 18px; color: #222; }
    header { display:flex; align-items:center; justify-content:space-between; }
    h1 { margin:0; font-size:1.5rem; }
    .columns { display:flex; gap:20px; margin-top:16px; }
    .card { flex:1; background:#fafafa; padding:12px; border-radius:8px; box-shadow:0 1px 3px rgba(0,0,0,0.06); }
    ul { list-style:none; padding:0; margin:0; max-height:380px; overflow:auto; }
    li { padding:8px 6px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center; }
    .muted { color:#666; font-size:0.9rem; }
    button { padding:6px 10px; margin-left:8px; cursor:pointer; border-radius:6px; border:1px solid #ccc; background:#fff;}
    .controls { display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
    .small { font-size:0.9rem; padding:4px 8px; }
    .green { border-color:#18a058; color:#0b7a3a; }
    .red { border-color:#d9534f; color:#a1332c; }
    .flex-row { display:flex; gap:8px; align-items:center; }
    input[type="text"], input[type="number"] { padding:6px; border-radius:6px; border:1px solid #ddd; }
    /* Invoice modal */
    .modal { position:fixed; inset:0; display:none; background:rgba(0,0,0,0.4); align-items:center; justify-content:center; z-index:999; }
    .modal.open { display:flex; }
    .invoice { background:#fff; padding:18px; width:800px; max-width:96%; border-radius:8px; box-shadow:0 8px 30px rgba(0,0,0,0.3); }
    .invoice header { display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; }
    .invoice .items { width:100%; border-collapse:collapse; margin-top:12px; }
    .invoice .items th, .invoice .items td { border-bottom:1px dashed #ddd; padding:8px; text-align:left; }
    /* Print styles */
    @media print {
      body * { visibility: hidden; }
      .invoice, .invoice * { visibility: visible; }
      .invoice { position: absolute; left:0; top:0; width:100%; }
    }
    /* Responsive */
    @media (max-width:800px) {
      .columns { flex-direction:column; }
    }
  </style>
  <!-- Supabase JS (module import used in script below) -->
</head>
<body>
  <header>
    <h1>Pathirage Electronics ‚Äî POS Dashboard</h1>
    <div class="flex-row">
      <span class="muted">Synced with Supabase</span>
      <button id="btn-refresh" title="Refresh data" class="small">üîÅ Refresh</button>
    </div>
  </header>

  <div class="columns" style="margin-top:14px;">
    <div class="card">
      <h3>Inventory</h3>
      <ul id="inventory-list"></ul>
      <div class="controls" style="margin-top:10px;">
        <input id="inv-name" placeholder="Name" type="text"/>
        <input id="inv-price" placeholder="Price" type="number" />
        <input id="inv-stock" placeholder="Stock" type="number" />
        <button id="btn-add-inv" class="small">‚ûï Add</button>
      </div>
    </div>

    <div class="card">
      <h3>Sales</h3>
      <ul id="sales-list"></ul>
      <div class="controls" style="margin-top:10px;">
        <input id="sale-item" placeholder="Item name" type="text" />
        <input id="sale-qty" placeholder="Qty" type="number" />
        <input id="sale-total" placeholder="Total LKR" type="number" />
        <button id="btn-add-sale" class="small green">Add Sale</button>
        <button id="btn-print-last" class="small">Print Last</button>
      </div>
    </div>

    <div class="card">
      <h3>Repairs</h3>
      <ul id="repairs-list"></ul>
      <div class="controls" style="margin-top:10px;">
        <input id="rep-customer" placeholder="Customer" type="text" />
        <input id="rep-device" placeholder="Device" type="text" />
        <select id="rep-status"><option>Pending</option><option>In Progress</option><option>Ready</option><option>Completed</option></select>
        <input id="rep-price" placeholder="Price LKR" type="number" />
        <button id="btn-add-repair" class="small green">Add Repair</button>
      </div>
      <div style="margin-top:8px;">
        <label class="muted">When a repair is moved to <b>Ready</b> or <b>Completed</b> you can send an SMS:</label>
      </div>
    </div>
  </div>

  <!-- Invoice Modal -->
  <div id="modal" class="modal">
    <div class="invoice" role="dialog" aria-modal="true">
      <header>
        <div>
          <strong>Pathirage Electronics</strong><br/>
          <span class="muted">Invoice / Repair Note</span>
        </div>
        <div id="inv-meta" style="text-align:right;"></div>
      </header>
      <div id="inv-body">
        <!-- Filled by JS -->
      </div>
      <div style="margin-top:12px; display:flex; justify-content:flex-end; gap:8px;">
        <button id="btn-print" class="small">Print</button>
        <button id="btn-close-modal" class="small red">Close</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/supabase.min.js'

    // === CONFIG - replace these with your project details ===
    const SUPABASE_URL = 'https://tzcttdubkddjyaohqhku.supabase.co'
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR6Y3R0ZHVia2Rkanlhb2hxaGt1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA0NjEwMjEsImV4cCI6MjA3NjAzNzAyMX0.MjP-Dze6XpWWqQs7oWBrt_zrmK1Bamyot-K-Z4ST-pk'
    // =======================================================

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

    // DOM refs
    const inventoryList = document.getElementById('inventory-list')
    const salesList = document.getElementById('sales-list')
    const repairsList = document.getElementById('repairs-list')

    const btnRefresh = document.getElementById('btn-refresh')
    const btnAddInv = document.getElementById('btn-add-inv')
    const btnAddSale = document.getElementById('btn-add-sale')
    const btnAddRepair = document.getElementById('btn-add-repair')
    const btnPrintLast = document.getElementById('btn-print-last')

    const modal = document.getElementById('modal')
    const invBody = document.getElementById('inv-body')
    const invMeta = document.getElementById('inv-meta')
    const btnPrint = document.getElementById('btn-print')
    const btnCloseModal = document.getElementById('btn-close-modal')

    // Local cache of last inserted
    let lastSale = null
    let lastRepair = null

    // ---------- Load functions ----------
    async function loadInventory() {
      const { data, error } = await supabase.from('inventory').select('*').order('id', { ascending: false })
      if (error) { console.error('Inventory load error', error); return }
      inventoryList.innerHTML = ''
      data.forEach(item => {
        const li = document.createElement('li')
        li.innerHTML = `<div><strong>${escapeHtml(item.name)}</strong> <span class="muted">LKR ${item.price} ‚Ä¢ stock ${item.stock}</span></div>
                        <div><button class="small" data-id="${item.id}" data-name="${escapeHtml(item.name)}">‚ùå del</button></div>`
        inventoryList.appendChild(li)
      })
      // attach delete handlers
      inventoryList.querySelectorAll('button').forEach(b => {
        b.addEventListener('click', async (e) => {
          const id = b.dataset.id
          if (!confirm('Delete inventory item?')) return
          const { error } = await supabase.from('inventory').delete().eq('id', id)
          if (error) return alert('Delete failed: '+error.message)
          loadInventory()
        })
      })
    }

    async function loadSales() {
      const { data, error } = await supabase.from('sales').select('*').order('id', { ascending: false })
      if (error) { console.error('Sales load error', error); return }
      salesList.innerHTML = ''
      data.forEach(sale => {
        const li = document.createElement('li')
        li.innerHTML = `<div><strong>${escapeHtml(sale.item)}</strong> <span class="muted">Qty: ${sale.quantity} ‚Ä¢ LKR ${sale.total}</span></div>
                        <div><button class="small" data-id="${sale.id}">üñ®Ô∏èinvoice</button></div>`
        salesList.appendChild(li)
      })
      // invoice buttons
      salesList.querySelectorAll('button').forEach(b => {
        b.addEventListener('click', async (e) => {
          const id = b.dataset.id
          const { data } = await supabase.from('sales').select('*').eq('id', id).single()
          showInvoice({ type:'sale', record: data })
        })
      })
    }

    async function loadRepairs() {
      const { data, error } = await supabase.from('repairs').select('*').order('id', { ascending: false })
      if (error) { console.error('Repairs load error', error); return }
      repairsList.innerHTML = ''
      data.forEach(rep => {
        const li = document.createElement('li')
        li.innerHTML = `<div><strong>${escapeHtml(rep.customer)}</strong> <span class="muted">${escapeHtml(rep.device)} ‚Ä¢ ${rep.status} ‚Ä¢ LKR ${rep.price}</span></div>
                        <div>
                          <button class="small" data-id="${rep.id}" data-action="sms">üì©SMS</button>
                          <button class="small" data-id="${rep.id}" data-action="edit">‚úèÔ∏è</button>
                          <button class="small" data-id="${rep.id}" data-action="del">‚ùå</button>
                        </div>`
        repairsList.appendChild(li)
      })
      // attach handlers for sms/edit/delete
      repairsList.querySelectorAll('button').forEach(b => {
        b.addEventListener('click', async (e) => {
          const id = b.dataset.id
          const action = b.dataset.action
          if (action === 'sms') {
            const { data } = await supabase.from('repairs').select('*').eq('id', id).single()
            openSmsForRepair(data)
          } else if (action === 'edit') {
            const { data } = await supabase.from('repairs').select('*').eq('id', id).single()
            showInvoice({ type:'repair', record: data, editable:true })
          } else if (action === 'del') {
            if (!confirm('Delete repair record?')) return
            const { error } = await supabase.from('repairs').delete().eq('id', id)
            if (error) return alert('Delete failed: '+error.message)
            loadRepairs()
          }
        })
      })
    }

    // ---------- Add / Insert ----------
    btnAddInv.addEventListener('click', async () => {
      const name = document.getElementById('inv-name').value.trim()
      const price = parseFloat(document.getElementById('inv-price').value || 0)
      const stock = parseInt(document.getElementById('inv-stock').value || 0, 10)
      if (!name) return alert('Enter inventory name')
      const { error } = await supabase.from('inventory').insert([{ name, price, stock }])
      if (error) return alert('Insert failed: '+error.message)
      document.getElementById('inv-name').value = ''
      document.getElementById('inv-price').value = ''
      document.getElementById('inv-stock').value = ''
      loadInventory()
    })

    btnAddSale.addEventListener('click', async () => {
      const item = document.getElementById('sale-item').value.trim()
      const qty = parseInt(document.getElementById('sale-qty').value || 0, 10)
      const total = parseFloat(document.getElementById('sale-total').value || 0)
      if (!item || !qty || !total) return alert('Enter sale item, qty and total')
      const { data, error } = await supabase.from('sales').insert([{ item, quantity: qty, total }]).select().single()
      if (error) return alert('Add sale failed: '+error.message)
      lastSale = data
      document.getElementById('sale-item').value = ''; document.getElementById('sale-qty').value = ''; document.getElementById('sale-total').value = ''
      loadSales()
      // auto show invoice for the sale
      showInvoice({ type:'sale', record: data })
    })

    btnAddRepair.addEventListener('click', async () => {
      const customer = document.getElementById('rep-customer').value.trim()
      const device = document.getElementById('rep-device').value.trim()
      const status = document.getElementById('rep-status').value
      const price = parseFloat(document.getElementById('rep-price').value || 0)
      if (!customer || !device) return alert('Enter customer and device')
      const { data, error } = await supabase.from('repairs').insert([{ customer, device, status, price }]).select().single()
      if (error) return alert('Add repair failed: '+error.message)
      lastRepair = data
      document.getElementById('rep-customer').value=''; document.getElementById('rep-device').value=''; document.getElementById('rep-price').value=''
      loadRepairs()
      // If status is Ready or Completed, optionally open SMS
      if (['Ready','Completed'].includes(status)) openSmsForRepair(data)
      showInvoice({ type:'repair', record: data })
    })

    // Print last sale button
    btnPrintLast.addEventListener('click', () => {
      if (!lastSale) return alert('No last sale stored - create a sale first')
      showInvoice({ type:'sale', record: lastSale })
    })

    // Manual refresh
    btnRefresh.addEventListener('click', () => {
      loadAll()
    })

    // ---------- Invoice modal functions ----------
    function showInvoice({ type, record, editable=false }) {
      invMeta.innerHTML = `<div><small class="muted">${type.toUpperCase()}</small><br/><strong>ID: ${record.id}</strong></div>`
      if (type === 'sale') {
        invBody.innerHTML = `
          <div><strong>Item:</strong> ${escapeHtml(record.item)}</div>
          <div><strong>Quantity:</strong> ${record.quantity}</div>
          <div><strong>Total:</strong> LKR ${record.total}</div>
          <div style="margin-top:10px;"><small class="muted">Thank you for your purchase.</small></div>
        `
      } else {
        // repair
        invBody.innerHTML = `
          <div><strong>Customer:</strong> ${escapeHtml(record.customer)}</div>
          <div><strong>Device:</strong> ${escapeHtml(record.device)}</div>
          <div><strong>Status:</strong> ${escapeHtml(record.status)}</div>
          <div><strong>Price:</strong> LKR ${record.price}</div>
          <div style="margin-top:10px;"><small class="muted">Please keep this note for collection.</small></div>
        `
      }

      modal.classList.add('open')
      // Print action
      btnPrint.onclick = () => { window.print() }
      // If editable, allow quick update of status from modal (simple UX)
      if (editable && type === 'repair') {
        const editBtn = document.createElement('button')
        editBtn.textContent = 'Mark Ready'
        editBtn.className = 'small green'
        editBtn.style.marginRight = '8px'
        editBtn.onclick = async () => {
          const { error } = await supabase.from('repairs').update({ status: 'Ready' }).eq('id', record.id)
          if (error) return alert('Update failed: '+error.message)
          loadRepairs()
          // open SMS when ready
          openSmsForRepair(Object.assign({}, record, { status: 'Ready' }))
          modal.classList.remove('open')
        }
        btnCloseModal.before(editBtn)
      }
    }

    btnCloseModal.addEventListener('click', () => {
      modal.classList.remove('open')
    })

    // Create SMS link and open it (works on mobile devices)
    function openSmsForRepair(rep) {
      // You'll want a phone number field in table or ask operator to enter number. We'll try to support 'phone' column if present.
      const phone = rep.phone || prompt('Enter customer phone number (start with country code, e.g. 94...)', '')
      if (!phone) return alert('Phone required')
      const body = `Hello ${rep.customer}, your ${rep.device} is ${rep.status}. Final price: LKR ${rep.price}. - Pathirage Electronics`
      // For most mobile browsers, sms: supports body parameter. Use encodeURIComponent.
      let smsLink = `sms:${phone}?body=${encodeURIComponent(body)}`
      // open the link to launch the phone's SMS app
      window.location.href = smsLink
    }

    // ---------- Real-time subscriptions ----------
    function subscribeRealtime() {
      // Sales changes
      supabase.channel('public:sales')
        .on('postgres_changes', { event: '*', schema: 'public', table: 'sales' }, payload => {
          console.log('sales change', payload)
          loadSales()
        })
        .on('postgres_changes', { event: '*', schema: 'public', table: 'inventory' }, payload => {
          console.log('inventory change', payload)
          loadInventory()
        })
        .on('postgres_changes', { event: '*', schema: 'public', table: 'repairs' }, payload => {
          console.log('repairs change', payload)
          loadRepairs()
        })
        .subscribe()
    }

    // ---------- Boot / Load All ----------
    async function loadAll() {
      try {
        await Promise.all([loadInventory(), loadSales(), loadRepairs()])
      } catch (err) {
        console.error('LoadAll error', err)
      }
    }

    // helper: escape for safety when injecting small bits of text
    function escapeHtml(unsafe) {
      if (unsafe === null || unsafe === undefined) return ''
      return String(unsafe)
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'",'&#039;')
    }

    // init
    (async () => {
      await loadAll()
      subscribeRealtime()
      console.log('POS initialized')
    })()
  </script>
</body>
</html>
